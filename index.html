<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach Day!</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  font-family: 'Segoe UI', Tahoma, sans-serif;
}

#stage {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: url('beach.png') center / cover no-repeat;
  overflow: hidden;
}

/* ── HUD ────────────────────────────────────────── */
#hud {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  z-index: 100;
  background: rgba(255, 255, 255, 0.82);
  border-radius: 22px;
  padding: 9px 24px 11px;
  box-shadow: 0 2px 14px rgba(0,0,0,0.2);
  white-space: nowrap;
}

#progressText {
  font-size: 14px;
  font-weight: 700;
  color: #444;
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

#progressBar {
  width: 180px;
  height: 11px;
  background: #ddd;
  border-radius: 6px;
  overflow: hidden;
}

#progressFill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #f7c948, #f0923c);
  border-radius: 6px;
  transition: width 0.45s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ── Dog container ──────────────────────────────── */
#dogContainer {
  position: absolute;
  bottom: 18%;
  left: 50%;
  transform: translateX(-50%);
  width: clamp(360px, 46vw, 580px);
  height: clamp(360px, 46vw, 580px);
}

#dogSad, #dogJuice, #dogJuiceCream, #dogHappy {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: contain;
  transition: opacity 0.65s ease;
}

#dogJuice,
#dogJuiceCream,
#dogHappy { opacity: 0; }

/* ── Equipped overlays ──────────────────────────── */
#equipJuice {
  position: absolute;
  width: 30%;
  left: -14%;
  bottom: 22%;
  opacity: 0;
  object-fit: contain;
  transition: opacity 0.35s ease;
  pointer-events: none;
}

#equipSunCream {
  position: absolute;
  width: 25%;
  right: -12%;
  top: 22%;
  opacity: 0;
  object-fit: contain;
  transition: opacity 0.35s ease;
  pointer-events: none;
}

#equipSwimRing {
  position: absolute;
  width:  clamp(120px, 15vw, 190px);
  height: clamp(120px, 15vw, 190px);
  bottom: 57%;
  left: 62%;
  opacity: 0;
  object-fit: contain;
  transition: opacity 0.6s ease;
  pointer-events: none;
}

#equipSwimRing.floating {
  animation: swimRingBob 2.4s ease-in-out infinite;
}

@keyframes swimRingBob {
  0%, 100% { transform: translateY(0px)   rotate(-4deg); }
  50%       { transform: translateY(-10px) rotate(4deg); }
}

/* ── Sad cloud ──────────────────────────────────── */
#sadCloud {
  position: absolute;
  top: -18%;
  left: 50%;
  transform: translateX(-50%);
  transition: opacity 0.55s ease;
  animation: cloudFloat 2.2s ease-in-out infinite;
  pointer-events: none;
}

@keyframes cloudFloat {
  0%, 100% { transform: translateX(-50%) translateY(0px); }
  50%       { transform: translateX(-50%) translateY(-8px); }
}

/* ── Sand items ─────────────────────────────────── */
.sand-item {
  position: absolute;
  width:  clamp(130px, 17vw, 210px);
  height: clamp(130px, 17vw, 210px);
  cursor: pointer;
  user-select: none;
  transition: opacity 0.3s ease;
}

.sand-item img,
.sand-item svg {
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
  transition: transform 0.18s ease, filter 0.2s ease;
  display: block;
}

.sand-item:hover:not(.used) img,
.sand-item:hover:not(.used) svg {
  filter: drop-shadow(0 0 12px rgba(255, 220, 0, 1)) drop-shadow(0 0 5px rgba(255, 180, 0, 0.8));
  transform: scale(1.1);
}

.sand-item.used {
  opacity: 0.35;
  pointer-events: none;
}

/* Checkmark badge */
.checkmark {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 28px;
  height: 28px;
  background: #27ae60;
  border: 2.5px solid #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  color: white;
  line-height: 1;
  opacity: 0;
  transform: scale(0);
  transition: opacity 0.2s ease, transform 0.38s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  z-index: 10;
}

.checkmark.shown {
  opacity: 1;
  transform: scale(1);
}

/* Sun-cream & swim-ring are larger than juice */
#itemSunCream,
#itemSwimRing {
  width:  clamp(190px, 24vw, 300px);
  height: clamp(190px, 24vw, 300px);
}

/* Item positions — side items pushed to 5% to clear the wider dog */
#itemJuice    { bottom: 20%; left: 5%; }
#itemSunCream { bottom: 4%;  left: 50%; transform: translateX(-50%); }
#itemSwimRing { bottom: 20%; right: 5%; }

/* ── Swim-ring drag interaction ─────────────────── */
#itemSwimRing          { cursor: grab; }
#itemSwimRing.dragging { opacity: 0.25 !important; cursor: grabbing; }

/* Glow the dog when a dragged item is hovering over it */
#dogContainer.drop-glow {
  filter: drop-shadow(0 0 24px rgba(255, 220, 0, 1))
          drop-shadow(0 0 10px rgba(255, 180, 0, 0.85));
}

/* Small label beneath the swim ring to signal "drag me" */
.drag-hint {
  position: absolute;
  bottom: -26px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.52);
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.8px;
  padding: 3px 10px;
  border-radius: 10px;
  white-space: nowrap;
  pointer-events: none;
  user-select: none;
}
#itemSwimRing.used .drag-hint { display: none; }

/* ── Hint text ──────────────────────────────────── */
#hintText {
  position: absolute;
  bottom: 17%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(210, 50, 50, 0.9);
  color: #fff;
  padding: 7px 20px;
  border-radius: 22px;
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.5px;
  opacity: 0;
  pointer-events: none;
  z-index: 50;
  white-space: nowrap;
  transition: opacity 0.3s ease;
}

/* ── Star burst ─────────────────────────────────── */
#starBurst {
  position: absolute;
  top: -42%;
  left: 50%;
  transform: translateX(-50%);
  width: 140%;
  height: 110px;
  pointer-events: none;
}

.star {
  position: absolute;
  clip-path: polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);
  animation: starPop 0.95s ease-out forwards;
  opacity: 0;
}

@keyframes starPop {
  0%   { transform: scale(0) rotate(0deg);   opacity: 0; }
  35%  { opacity: 1; transform: scale(1.6) rotate(160deg); }
  100% { transform: scale(0.3) rotate(340deg) translateY(-28px); opacity: 0; }
}

/* ── Shake ──────────────────────────────────────── */
@keyframes shake {
  0%,100% { transform: translateX(0) rotate(0deg); }
  14%      { transform: translateX(-10px) rotate(-4deg); }
  28%      { transform: translateX(10px)  rotate(4deg); }
  42%      { transform: translateX(-7px) rotate(-2deg); }
  57%      { transform: translateX(7px)  rotate(2deg); }
  71%      { transform: translateX(-3px); }
  85%      { transform: translateX(3px); }
}

@keyframes shakeCentered {
  0%,100% { transform: translateX(-50%) rotate(0deg); }
  14%      { transform: translateX(calc(-50% - 10px)) rotate(-4deg); }
  28%      { transform: translateX(calc(-50% + 10px)) rotate(4deg); }
  42%      { transform: translateX(calc(-50% - 7px)) rotate(-2deg); }
  57%      { transform: translateX(calc(-50% + 7px)) rotate(2deg); }
  71%      { transform: translateX(calc(-50% - 3px)); }
  85%      { transform: translateX(calc(-50% + 3px)); }
}

.shake         { animation: shake 0.52s ease !important; }
.shakeCentered { animation: shakeCentered 0.52s ease !important; }

/* ── Splash ─────────────────────────────────────── */
.splash-drop {
  position: absolute;
  border-radius: 50%;
  background: rgba(100, 200, 255, 0.78);
  animation: splashPop 0.8s ease-out forwards;
}

@keyframes splashPop {
  0%   { transform: scale(0);   opacity: 0.9; }
  55%  { opacity: 0.6; }
  100% { transform: scale(3.5); opacity: 0; }
}

/* ── Dog bob ────────────────────────────────────── */
@keyframes dogBob {
  0%,100% { transform: translateX(-50%) translateY(0px); }
  50%     { transform: translateX(-50%) translateY(-10px); }
}

/* ── End overlay ────────────────────────────────── */
#endOverlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 80, 190, 0.3);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.9s ease;
  z-index: 300;
}

#endOverlay.visible {
  opacity: 1;
  pointer-events: all;
}

#endOverlay h1 {
  font-size: clamp(28px, 6vw, 58px);
  color: #fff;
  text-shadow: 0 3px 14px rgba(0,0,0,0.5);
  letter-spacing: 4px;
  animation: bounceIn 0.7s cubic-bezier(0.68,-0.55,0.27,1.55) both;
}

#endOverlay .end-sub {
  font-size: clamp(14px, 3vw, 24px);
  color: rgba(255,255,255,0.92);
  margin-top: 12px;
  text-shadow: 0 1px 6px rgba(0,0,0,0.3);
}

#endOverlay .restart-hint {
  margin-top: 22px;
  font-size: clamp(11px, 1.8vw, 15px);
  color: rgba(255,255,255,0.5);
  letter-spacing: 0.5px;
}

@keyframes bounceIn {
  0%  { transform: scale(0.4); opacity: 0; }
  60% { transform: scale(1.12); }
  100%{ transform: scale(1);    opacity: 1; }
}
</style>
</head>
<body>
<div id="stage">

  <!-- HUD -->
  <div id="hud">
    <div id="progressText">PREP: 0 / 3</div>
    <div id="progressBar"><div id="progressFill"></div></div>
  </div>

  <!-- ── Sand items ── -->
  <div id="itemJuice" class="sand-item">
    <img src="juice.png" alt="Juice">
    <div class="checkmark">&#10003;</div>
  </div>

  <div id="itemSunCream" class="sand-item">
    <img src="sun-cream.png" alt="Sun Cream">
    <div class="checkmark">&#10003;</div>
  </div>

  <div id="itemSwimRing" class="sand-item">
    <img src="swim-ring.png" alt="Swim Ring">
    <div class="checkmark">&#10003;</div>
    <div class="drag-hint">drag to dog ↑</div>
  </div>

  <!-- ── Dog container ── -->
  <div id="dogContainer">

    <img id="dogSad"       src="sad-dog.png"              alt="Sad Dog">
    <img id="dogJuice"     src="dog-juice.png"            alt="Dog with Juice">
    <img id="dogJuiceCream" src="dog-juice-sun cream.png" alt="Dog with Juice and Sun Cream">
    <img id="dogHappy"     src="happy-dog.png"            alt="Happy Dog">

    <!-- Equipped overlays -->
    <img id="equipJuice"    src="juice.png"     alt="">
    <img id="equipSunCream" src="sun-cream.png" alt="">

    <!-- Sad cloud SVG -->
    <div id="sadCloud">
      <svg width="80" height="48" viewBox="0 0 80 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <ellipse cx="40" cy="36" rx="32" ry="14" fill="#aaa" opacity="0.65"/>
        <ellipse cx="24" cy="29" rx="16" ry="11" fill="#bbb" opacity="0.7"/>
        <ellipse cx="54" cy="28" rx="14" ry="10" fill="#bbb" opacity="0.7"/>
        <ellipse cx="40" cy="22" rx="18" ry="13" fill="#ccc" opacity="0.78"/>
      </svg>
    </div>

    <!-- Star burst -->
    <div id="starBurst"></div>

  </div><!-- /dogContainer -->

  <!-- Swim ring floating on sea (shown after dog reaches ocean) -->
  <img id="equipSwimRing" src="swim-ring.png" alt="">

  <!-- Splash anchor (positioned by JS) -->
  <div id="splash" style="position:fixed;pointer-events:none;z-index:160;"></div>

  <!-- Hint text -->
  <div id="hintText">Not yet!</div>

  <!-- End overlay -->
  <div id="endOverlay">
    <h1>READY TO SWIM!</h1>
    <p class="end-sub">dog: happy</p>
    <p class="restart-hint">click anywhere to restart</p>
  </div>

</div><!-- #stage -->

<script>
(function () {
  'use strict';

  // ── State ─────────────────────────────────────────────────────────
  let step      = 0;
  let busy      = false;
  let endShown  = false;
  let hintTimer = null;

  // ── Drag state (swim ring) ─────────────────────────────────────────
  let dragActive = false;
  let dragClone  = null;
  let dragOX     = 0;
  let dragOY     = 0;

  // ── Elements ──────────────────────────────────────────────────────
  const dogContainer  = document.getElementById('dogContainer');
  const dogSad        = document.getElementById('dogSad');
  const dogJuice      = document.getElementById('dogJuice');
  const dogJuiceCream = document.getElementById('dogJuiceCream');
  const dogHappy      = document.getElementById('dogHappy');
  const sadCloud      = document.getElementById('sadCloud');

  // Intermediate dog states indexed by step count (0–3)
  const DOG_STATES = [dogSad, dogJuice, dogJuiceCream, dogHappy];
  let activeDog = dogSad;
  const starBurst    = document.getElementById('starBurst');
  const hintText     = document.getElementById('hintText');
  const endOverlay   = document.getElementById('endOverlay');
  const splash       = document.getElementById('splash');
  const progressText = document.getElementById('progressText');
  const progressFill = document.getElementById('progressFill');

  const itemJuice    = document.getElementById('itemJuice');
  const itemSunCream = document.getElementById('itemSunCream');
  const itemSwimRing = document.getElementById('itemSwimRing');
  const equipJuice   = document.getElementById('equipJuice');
  const equipSunCream= document.getElementById('equipSunCream');
  const equipSwimRing= document.getElementById('equipSwimRing');

  const ITEMS = [
    { el: itemJuice,    equip: equipJuice,    stepIdx: 0, centered: false },
    { el: itemSunCream, equip: equipSunCream,  stepIdx: 1, centered: true  },
    { el: itemSwimRing, equip: equipSwimRing,  stepIdx: 2, centered: false },
  ];

  // ── Init ──────────────────────────────────────────────────────────
  function init() {
    // Juice and sun-cream: click interaction
    ITEMS.slice(0, 2).forEach(item =>
      item.el.addEventListener('click', () => onItemClick(item))
    );
    // Swim ring: drag interaction
    initRingDrag();
    endOverlay.addEventListener('click', restart);
  }

  // ── Click (juice & sun-cream) ─────────────────────────────────────
  function onItemClick(item) {
    if (busy || endShown) return;
    if (item.el.classList.contains('used')) return;
    if (item.stepIdx === step) applyItem(item);
    else                       wrongItem(item);
  }

  // ── Wrong order feedback ──────────────────────────────────────────
  function wrongItem(item) {
    item.el.classList.remove('shake', 'shakeCentered');
    void item.el.offsetWidth;
    item.el.classList.add(item.centered ? 'shakeCentered' : 'shake');
    setTimeout(() => item.el.classList.remove('shake', 'shakeCentered'), 560);

    if (hintTimer) clearTimeout(hintTimer);
    hintText.style.opacity = '1';
    hintTimer = setTimeout(() => { hintText.style.opacity = '0'; }, 1500);
  }

  // ── Apply correct item ────────────────────────────────────────────
  function applyItem(item) {
    busy = true;
    flyToDog(item, () => {
      // Swim ring equip is shown floating on the sea later, not on the dog
      if (item.stepIdx !== 2) item.equip.style.opacity = '1';
      item.el.classList.add('used');
      item.el.querySelector('.checkmark').classList.add('shown');
      step++;
      updateHUD();
      // Crossfade dog to intermediate state for steps 1 and 2
      if (step < 3) crossfadeDog(DOG_STATES[step]);
      busy = false;
      if (step === 3) setTimeout(completeAll, 420);
    });
  }

  // ── Fly animation ─────────────────────────────────────────────────
  function flyToDog(item, cb) {
    const fromRect = item.el.getBoundingClientRect();
    const dogRect  = dogContainer.getBoundingClientRect();

    const imgEl = item.el.querySelector('img');
    const clone = document.createElement('img');
    clone.src   = imgEl.currentSrc || imgEl.src;

    const startX = fromRect.left + fromRect.width  / 2 - 38;
    const startY = fromRect.top  + fromRect.height / 2 - 38;

    clone.style.cssText = [
      'position:fixed',
      'width:76px', 'height:76px',
      'object-fit:contain',
      'pointer-events:none',
      'z-index:500',
      'left:' + startX + 'px',
      'top:'  + startY + 'px',
      'transition:left .65s cubic-bezier(.25,.46,.45,.94),'
                + 'top .65s cubic-bezier(.25,.46,.45,.94),'
                + 'transform .65s ease,'
                + 'opacity .18s ease .54s',
    ].join(';');
    document.body.appendChild(clone);

    const tx = dogRect.left + dogRect.width  / 2 - 38;
    const ty = dogRect.top  + dogRect.height / 2 - 38;

    requestAnimationFrame(() => requestAnimationFrame(() => {
      clone.style.left      = tx + 'px';
      clone.style.top       = ty + 'px';
      clone.style.transform = 'scale(0.5)';
      clone.style.opacity   = '0';
    }));

    setTimeout(() => { document.body.removeChild(clone); cb(); }, 800);
  }

  // ── HUD ───────────────────────────────────────────────────────────
  function updateHUD() {
    progressText.textContent = 'PREP: ' + step + ' / 3';
    progressFill.style.width = (step / 3 * 100) + '%';
  }

  // ── Dog crossfade ─────────────────────────────────────────────────
  function crossfadeDog(toEl) {
    if (activeDog === toEl) return;
    activeDog.style.opacity = '0';
    toEl.style.opacity      = '1';
    activeDog = toEl;
  }

  // ══════════════════════════════════════════════════════════════════
  // ── Swim-ring drag logic ──────────────────────────────────────────
  // ══════════════════════════════════════════════════════════════════

  function initRingDrag() {
    itemSwimRing.addEventListener('mousedown',  onRingPointerDown);
    itemSwimRing.addEventListener('touchstart', onRingTouchStart, { passive: false });
  }

  // ── pointer-down / touch-start ────────────────────────────────────
  function onRingPointerDown(e) {
    if (busy || endShown || itemSwimRing.classList.contains('used')) return;
    e.preventDefault();
    beginDrag(e.clientX, e.clientY);
    document.addEventListener('mousemove', onRingPointerMove);
    document.addEventListener('mouseup',   onRingPointerUp);
  }

  function onRingTouchStart(e) {
    if (busy || endShown || itemSwimRing.classList.contains('used')) return;
    e.preventDefault();
    const t = e.touches[0];
    beginDrag(t.clientX, t.clientY);
    document.addEventListener('touchmove', onRingTouchMove, { passive: false });
    document.addEventListener('touchend',  onRingTouchEnd);
  }

  // ── begin: spawn floating clone ───────────────────────────────────
  function beginDrag(cx, cy) {
    const rect  = itemSwimRing.getBoundingClientRect();
    const imgEl = itemSwimRing.querySelector('img');

    dragClone = document.createElement('img');
    dragClone.src = imgEl.currentSrc || imgEl.src;
    dragClone.style.cssText =
      'position:fixed;'
      + 'width:' + rect.width + 'px;height:' + rect.height + 'px;'
      + 'object-fit:contain;pointer-events:none;z-index:500;'
      + 'opacity:0.92;left:' + rect.left + 'px;top:' + rect.top + 'px;'
      + 'transition:none;';
    document.body.appendChild(dragClone);

    dragOX     = cx - rect.left;
    dragOY     = cy - rect.top;
    dragActive = true;

    itemSwimRing.classList.add('dragging');
  }

  // ── move ──────────────────────────────────────────────────────────
  function moveDrag(cx, cy) {
    if (!dragActive || !dragClone) return;
    dragClone.style.left = (cx - dragOX) + 'px';
    dragClone.style.top  = (cy - dragOY) + 'px';

    // Glow dog when the clone hovers over it
    const dr   = dogContainer.getBoundingClientRect();
    const over = cx >= dr.left && cx <= dr.right
              && cy >= dr.top  && cy <= dr.bottom;
    dogContainer.classList.toggle('drop-glow', over);
  }

  // ── end: drop or snap-back ────────────────────────────────────────
  function endDrag(cx, cy) {
    if (!dragActive) return;
    dragActive = false;

    document.removeEventListener('mousemove', onRingPointerMove);
    document.removeEventListener('mouseup',   onRingPointerUp);
    document.removeEventListener('touchmove', onRingTouchMove);
    document.removeEventListener('touchend',  onRingTouchEnd);

    dogContainer.classList.remove('drop-glow');

    const dr       = dogContainer.getBoundingClientRect();
    const onDog    = cx >= dr.left && cx <= dr.right
                  && cy >= dr.top  && cy <= dr.bottom;
    const ringItem = ITEMS[2];

    if (onDog) {
      // Released on dog ─ evaluate step
      removeDragClone();
      itemSwimRing.classList.remove('dragging');
      if (ringItem.stepIdx === step) {
        applyItem(ringItem);
      } else {
        wrongItem(ringItem);
      }
    } else {
      // Released elsewhere ─ animate clone back then restore
      const rect = itemSwimRing.getBoundingClientRect();
      dragClone.style.transition = 'left .32s ease, top .32s ease, opacity .32s ease';
      dragClone.style.left    = rect.left + 'px';
      dragClone.style.top     = rect.top  + 'px';
      dragClone.style.opacity = '0';
      setTimeout(() => {
        removeDragClone();
        itemSwimRing.classList.remove('dragging');
      }, 340);
    }
  }

  // ── helpers ───────────────────────────────────────────────────────
  function removeDragClone() {
    if (dragClone && dragClone.parentNode) dragClone.parentNode.removeChild(dragClone);
    dragClone = null;
  }

  function onRingPointerMove(e) { moveDrag(e.clientX, e.clientY); }
  function onRingPointerUp(e)   { endDrag(e.clientX, e.clientY); }
  function onRingTouchMove(e)   { e.preventDefault(); const t = e.touches[0]; moveDrag(t.clientX, t.clientY); }
  function onRingTouchEnd(e)    { const t = e.changedTouches[0]; endDrag(t.clientX, t.clientY); }

  // ══════════════════════════════════════════════════════════════════

  // ── All 3 applied ─────────────────────────────────────────────────
  function completeAll() {
    busy = true;
    sadCloud.style.opacity = '0';
    fireStars();
    setTimeout(() => {
      crossfadeDog(dogHappy);
      setTimeout(moveDogToOcean, 900);
    }, 1100);
  }

  // ── Stars ─────────────────────────────────────────────────────────
  function fireStars() {
    starBurst.innerHTML = '';
    const pal   = ['#FFD700','#FF6B6B','#7ECEF6','#98FB98','#FF69B4','#FFA500'];
    const spots = ['8% 50%','25% 12%','50% 55%','74% 10%','92% 48%','18% 82%','50% 0%','82% 80%'];
    spots.forEach((pos, i) => {
      const [l, t] = pos.split(' ');
      const s = document.createElement('div');
      s.className = 'star';
      s.style.cssText = 'left:' + l + ';top:' + t
        + ';width:'  + (9 + (i % 4) * 3) + 'px'
        + ';height:' + (9 + (i % 4) * 3) + 'px'
        + ';background:' + pal[i % pal.length]
        + ';animation-delay:' + (i * 0.09) + 's';
      starBurst.appendChild(s);
    });
    setTimeout(() => { starBurst.innerHTML = ''; }, 2400);
  }

  // ── Move dog to ocean ─────────────────────────────────────────────
  function moveDogToOcean() {
    dogContainer.style.transition = 'bottom 1.6s cubic-bezier(.4,0,.2,1)';
    dogContainer.style.bottom = '58%';
    setTimeout(() => {
      showSplash();
      equipSwimRing.style.opacity = '1';
      equipSwimRing.classList.add('floating');
      setTimeout(() => {
        dogContainer.style.transition = 'none';
        dogContainer.style.animation  = 'dogBob 1.6s ease-in-out infinite';
        showEndScreen();
      }, 900);
    }, 1650);
  }

  // ── Splash ────────────────────────────────────────────────────────
  function showSplash() {
    const r  = dogContainer.getBoundingClientRect();
    const cx = r.left + r.width / 2;
    const cy = r.bottom - r.height * 0.22;

    Object.assign(splash.style, {
      left: (cx - 65) + 'px', top: (cy - 32) + 'px',
      width: '130px', height: '65px', opacity: '1',
    });
    splash.innerHTML = '';

    [[10,42,19,0],[30,0,26,0.07],[50,52,21,0.04],[65,5,32,0.1],[82,38,17,0.03],[44,-22,23,0.06]]
      .forEach(([l, t, sz, d]) => {
        const dr = document.createElement('div');
        dr.className = 'splash-drop';
        dr.style.cssText = 'left:' + l + '%;top:' + t + '%;width:' + sz + 'px;height:' + sz + 'px;animation-delay:' + d + 's';
        splash.appendChild(dr);
      });

    setTimeout(() => { splash.innerHTML = ''; }, 1400);
  }

  // ── End screen ────────────────────────────────────────────────────
  function showEndScreen() {
    endShown = true;
    busy     = false;
    endOverlay.classList.add('visible');
  }

  // ── Restart ───────────────────────────────────────────────────────
  function restart() {
    // Cancel any live drag first
    dragActive = false;
    removeDragClone();
    itemSwimRing.classList.remove('dragging');
    dogContainer.classList.remove('drop-glow');

    step     = 0;
    busy     = false;
    endShown = false;

    updateHUD();
    endOverlay.classList.remove('visible');

    dogContainer.style.transition = 'none';
    dogContainer.style.animation  = 'none';
    dogContainer.style.bottom     = '18%';
    dogContainer.style.left       = '50%';
    DOG_STATES.forEach(d => { d.style.opacity = '0'; });
    dogSad.style.opacity = '1';
    activeDog = dogSad;

    sadCloud.style.opacity = '1';
    starBurst.innerHTML    = '';

    if (hintTimer) clearTimeout(hintTimer);
    hintText.style.opacity = '0';
    splash.innerHTML       = '';

    ITEMS.forEach(item => {
      item.el.classList.remove('used', 'shake', 'shakeCentered');
      item.el.querySelector('.checkmark').classList.remove('shown');
      item.equip.style.opacity = '0';
    });
    equipSwimRing.classList.remove('floating');
  }

  init();
}());
</script>
</body>
</html>
